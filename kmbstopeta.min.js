function exitHandler() {
    document.webkitIsFullScreen || document.mozFullScreen || document.msFullscreenElement || (etaMon.style.border =
        "2.5em solid #000", etaMon.style.fontSize = oldDpipSize, etaMon.style.boxShadow = "0em 0.05em 0.5em #999",
        etaMon.getElementsByClassName("monitor-panel")[0].style.width = "100%", etaMon.getElementsByClassName(
            "monitor-panel")[0].style.height = "100%", etaMon.getElementsByClassName("monitor-panel")[0].style.top =
        "0", etaMon.getElementsByClassName("monitor-panel")[0].style.left = "0", etaMon.getElementsByClassName(
            "monitor-panel")[0].style.transform = "unset", etaMon.getElementsByClassName("monitor-panel")[0].style.outline =
        "1em solid #1a1a1a")
}
async function ETAFullScreen() {
    document.webkitIsFullScreen || document.mozFullScreen || document.msFullscreenElement || (etaMon.requestFullscreen ?
        await etaMon.requestFullscreen() : etaMon.webkitRequestFullscreen ? await etaMon.webkitRequestFullscreen() :
        etaMon.msRequestFullscreen && await etaMon.msRequestFullscreen(), etaMon.style.border = "none", etaMon.style
        .boxShadow = "none", etaMon.getElementsByClassName("monitor-panel")[0].style.outline = "none", window.innerWidth /
        window.innerHeight < 1.78 ? (etaMon.style.fontSize = window.innerWidth / 53.33 + "px", etaMon.getElementsByClassName(
                "monitor-panel")[0].style.top = "50%", etaMon.getElementsByClassName("monitor-panel")[0].style.transform =
            "translateY(-50%)", etaMon.getElementsByClassName("monitor-panel")[0].style.height = "56.25vw") : (
            etaMon.style.fontSize = window.innerHeight / 30 + "px", etaMon.getElementsByClassName(
                "monitor-panel")[0].style.left = "50%", etaMon.getElementsByClassName("monitor-panel")[0].style
            .transform = "translateX(-50%)", etaMon.getElementsByClassName("monitor-panel")[0].style.width =
            "177.7vh"), document.webkitIsFullScreen || document.mozFullScreen || document.msFullscreenElement ||
        (oldDpipSize = etaMon.style.fontSize))
}

function refresh() {
    for (var e = 0; e < document.getElementsByClassName("kmb-eta-route").length; e++)
        if (e < routes.length) {
            var t = routes[e].split("-")[1];
            getETA(e, routes[e].split("-")[0], t.substring(0, t.length - 2), t.substring(t.length - 2, t.length - 1), t
                .substring(t.length - 1, t.length))
        } togglePage()
}

function getETA(e, t, n, o, a) {
    link = "https://data.etabus.gov.hk/v1/transport/kmb/eta/" + t + "/" + n + "/" + a, fetch(link).then(e => e.json()).then(
        t => {
            for (var a, l = 0; l < t.data.length; l++)
                if (t.data[l].dir == o) {
                    a = t.data[l];
                    break
                } switch (null == a || null == a.eta ? min = '<i class="kmb-exclaim"></i>' : (timeEta = new Date(
                    null == a.eta ? t.generated_timestamp : a.eta), timeNow = new Date(t.generated_timestamp),
                min = Math.round((timeEta - timeNow) / 1e3 / 60), min < 1 && (min = "-")), a.rmk_tc) {
                    case "原定班次":
                        remark = "(原定班次)";
                        break;
                    case "最後班次":
                        remark = "(最後班次)";
                        break;
                    case "最後班次已過":
                        remark = '<div style="color:red">最後班次已過本站</div>';
                        break;
                    case "暫停預報":
                        remark = '<div style="color:red">暫停預報</div>';
                        break;
                    case "服務只限於星期一至五 (公眾假期除外)":
                        remark = '<marquee style="color:red">服務只限於星期一至五(公眾假期除外)</marquee>';
                        break;
                    case "服務只限於星期一至六(公眾假期除外)":
                        remark = '<marquee style="color:red">服務只限於星期一至六(公眾假期除外)</marquee>';
                        break;
                    case "服務只限於星期日及公眾假期":
                        remark = '<marquee style="color:red">服務只限於星期日及公眾假期</marquee>';
                        break;
                default:
                    remark = a.rmk_tc
            }
            null == a.eta && "" == remark && (remark = '<div style="color:red">暫時沒有預定班次</div>'), document.getElementsByClassName(
                "kmb-eta-route")[e].getElementsByClassName("kmb-eta-route-num")[0].innerHTML = n, document.getElementsByClassName(
                "kmb-eta-route")[e].getElementsByClassName("kmb-eta-route-min")[0].innerHTML = min, document.getElementsByClassName(
                "kmb-eta-route")[e].getElementsByClassName("kmb-eta-route-remark")[0].innerHTML = remark
        })
}

function togglePage() {
    for (i = 0; i < document.getElementsByClassName("kmb-eta-route").length; i++) document.getElementsByClassName(
        "kmb-eta-route")[i].style.display = "none";
    for (i = 6 * currentPage; i < 6 * currentPage + 6; i++) document.getElementsByClassName("kmb-eta-route")[i].style.display =
        "block";
    currentPage = (currentPage + 1) % pages
}

function logo_dvd() {
    window.requestAnimationFrame(logo_dvd), fontSize = window.getComputedStyle(etaMon).fontSize.replace("px", ""),
        screenWidth = document.getElementsByClassName("kmb-eta-logo-playground")[0].clientWidth / fontSize,
        screenHeight = document.getElementsByClassName("kmb-eta-logo-playground")[0].clientHeight / fontSize, (posx >
            screenWidth - logoWidth || posx < 0) && (deltax *= -1, logoindex = (logoindex + 1) % 6, logo.src = "logos/" +
            logos[logoindex]), (posy > screenHeight - logoHeight || posy < 0) && (deltay *= -1, logoindex = (logoindex +
            1) % 6, logo.src = "logos/" + logos[logoindex]), posx += deltax, posy += deltay, logo.style.left = posx +
        "em", logo.style.top = posy + "em"
}
var data, currentSlot, etaMon = document.getElementsByClassName("eta-mon")[0].getElementsByClassName("monitor")[0],
    oldDpipSize = etaMon.style.fontSize;
document.addEventListener("keydown", function (e) {
    if (!e.defaultPrevented && document.getElementById("stop-search") !== document.activeElement) {
        switch (e.key) {
            case "f":
                ETAFullScreen();
                break;
            default:
                return
        }
        e.preventDefault()
    }
}, !0), document.addEventListener && (document.addEventListener("fullscreenchange", exitHandler, !1), document.addEventListener(
        "mozfullscreenchange", exitHandler, !1), document.addEventListener("MSFullscreenChange", exitHandler, !1),
    document.addEventListener("webkitfullscreenchange", exitHandler, !1));
var currentPage = 0;
refresh();
var logoWidth, logoHeight, posx, posy, deltax, deltay, intervalId = window.setInterval(() => refresh(), 15e3),
    fontSize = window.getComputedStyle(etaMon).fontSize.replace("px", "");
const logo = document.getElementsByClassName("kmb-eta-logo")[0],
    logos = ["c434fe08da5ee.webp", "c2705a991d711.webp", "c4cec872a8e67.webp", "c48fc9a0236da.webp",
        "c1aa83b4e5b4.webp", "c5a98c9eb2acd.webp", "c54420efa77e7.webp"];
var logoindex = 0;
logo.src = "logos/" + logos[logoindex], logoWidth = logo.clientWidth / fontSize, logoHeight = logo.clientHeight /
    fontSize, posx = 0, posy = 0, deltax = .03, deltay = .03, logo_dvd();